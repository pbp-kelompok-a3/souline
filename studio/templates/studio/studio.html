{% extends "base.html" %}

{% block meta %}
<title>Studio List - Souline</title>
{% endblock meta %}

{% block content %}
{% include "header.html" %}

<!-- Main Content Container -->
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <!-- Page Header -->
  <div class="mb-8">
    <h1 class="text-4xl font-bold text-[#446178] mb-2">Discover Your Perfect Studio</h1>
    <p class="text-lg text-[#FFA04D]">Find your space to move and breathe</p>
  </div>

  <!-- Admin Action Button (Only visible to staff/superuser) -->
  {% if user.is_staff or user.is_superuser %}
    <div class="mb-6">
      <a href="{% url 'studio:add_studio' %}" 
         class="inline-block px-6 py-3 bg-[#FFA04D] text-white rounded-lg hover:bg-[#ff8c2e] transition-all duration-300 font-medium shadow-md hover:shadow-lg">
        + Add New Studio
      </a>
    </div>
  {% endif %}

  <!-- Studios Container (Will be populated by AJAX) -->
  <div id="studios-container">
    <!-- Loading State -->
    <div id="loading-state" class="space-y-12">
      <div class="mb-12">
        <div class="mb-4">
          <div class="h-9 bg-gray-200 rounded-lg w-64 animate-pulse"></div>
        </div>
        <div class="carousel-container relative py-4">
          <div class="cards-wrapper flex gap-6 overflow-x-auto p-4">
            <!-- Skeleton Cards -->
            <div class="skeleton-card min-w-[320px] max-w-[320px] bg-white rounded-2xl overflow-hidden shadow-md flex-shrink-0">
              <div class="w-full h-48 bg-gray-200 animate-pulse"></div>
              <div class="p-5 space-y-3">
                <div class="h-6 bg-gray-200 rounded animate-pulse w-3/4"></div>
                <div class="h-4 bg-gray-200 rounded animate-pulse w-full"></div>
                <div class="h-4 bg-gray-200 rounded animate-pulse w-5/6"></div>
                <div class="h-4 bg-gray-200 rounded animate-pulse w-2/3"></div>
                <div class="h-10 bg-gray-200 rounded-lg animate-pulse w-full mt-2"></div>
              </div>
            </div>
            <div class="skeleton-card min-w-[320px] max-w-[320px] bg-white rounded-2xl overflow-hidden shadow-md flex-shrink-0">
              <div class="w-full h-48 bg-gray-200 animate-pulse"></div>
              <div class="p-5 space-y-3">
                <div class="h-6 bg-gray-200 rounded animate-pulse w-3/4"></div>
                <div class="h-4 bg-gray-200 rounded animate-pulse w-full"></div>
                <div class="h-4 bg-gray-200 rounded animate-pulse w-5/6"></div>
                <div class="h-4 bg-gray-200 rounded animate-pulse w-2/3"></div>
                <div class="h-10 bg-gray-200 rounded-lg animate-pulse w-full mt-2"></div>
              </div>
            </div>
            <div class="skeleton-card min-w-[320px] max-w-[320px] bg-white rounded-2xl overflow-hidden shadow-md flex-shrink-0">
              <div class="w-full h-48 bg-gray-200 animate-pulse"></div>
              <div class="p-5 space-y-3">
                <div class="h-6 bg-gray-200 rounded animate-pulse w-3/4"></div>
                <div class="h-4 bg-gray-200 rounded animate-pulse w-full"></div>
                <div class="h-4 bg-gray-200 rounded animate-pulse w-5/6"></div>
                <div class="h-4 bg-gray-200 rounded animate-pulse w-2/3"></div>
                <div class="h-10 bg-gray-200 rounded-lg animate-pulse w-full mt-2"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Error State (Hidden by default) -->
    <div id="error-state" class="hidden">
      <div class="bg-white rounded-2xl shadow-lg p-12 text-center">
        <div class="mb-6">
          <svg class="w-20 h-20 mx-auto text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
        </div>
        <h3 class="text-2xl font-semibold text-[#446178] mb-2">Oops! Something went wrong</h3>
        <p class="text-gray-600 mb-6">We couldn't load the studios. Please try again.</p>
        <button onclick="loadStudios()" 
                class="px-6 py-3 bg-[#FFA04D] text-white rounded-lg hover:bg-[#ff8c2e] transition-all duration-300 font-medium shadow-md hover:shadow-lg">
          Try Again
        </button>
      </div>
    </div>

    <!-- Content Container (Will be filled by AJAX) -->
    <div id="content-state" class="hidden space-y-12">
      <!-- Studios will be inserted here -->
    </div>
  </div>
</div>

<script>
  // Smooth scroll function for carousel navigation
  function scrollCarousel(carouselId, direction) {
    const carousel = document.querySelector(`[data-carousel="${carouselId}"]`);
    const wrapper = carousel.querySelector('.cards-wrapper');
    const cardWidth = 320 + 24; // Card width + gap
    const scrollAmount = cardWidth * 2; // Scroll 2 cards at a time
    
    wrapper.scrollBy({
      left: direction * scrollAmount,
      behavior: 'smooth'
    });
  }

  // Initialize carousel buttons
  function initializeCarousels() {
    const carousels = document.querySelectorAll('.carousel-container');
    
    carousels.forEach(carousel => {
      const wrapper = carousel.querySelector('.cards-wrapper');
      const leftBtn = carousel.querySelector('button:first-of-type');
      const rightBtn = carousel.querySelector('button:last-of-type');
      
      if (!leftBtn || !rightBtn) return;
      
      // Show/hide navigation buttons based on scroll position
      function updateButtons() {
        const canScrollLeft = wrapper.scrollLeft > 10;
        const canScrollRight = wrapper.scrollLeft < (wrapper.scrollWidth - wrapper.clientWidth - 10);
        
        leftBtn.classList.toggle('hidden', !canScrollLeft);
        rightBtn.classList.toggle('hidden', !canScrollRight);
      }
      
      // Update buttons on scroll and resize
      updateButtons();
      wrapper.addEventListener('scroll', updateButtons);
      window.addEventListener('resize', updateButtons);
    });
  }

  // Create studio card HTML
  function createStudioCard(studio) {
    const thumbnail = studio.thumbnail || 'https://via.placeholder.com/320x192?text=No+Image';
    const gmapsLink = studio.gmaps_link || '#';
    const isAdmin = {{ user.is_staff|lower }} || {{ user.is_superuser|lower }};
    
    // Delete button HTML (only for admins)
    const deleteButton = isAdmin ? `
      <button onclick="deleteStudio('${studio.id}', '${studio.nama_studio}')" class="inline-block mt-2 px-4 py-2 bg-red-500 text-white rounded-lg text-sm font-medium hover:bg-red-600 hover:scale-105 hover:shadow-md transition-all duration-300">
        üóëÔ∏è
      </button>
    ` : '';
    
    return `
      <div class="studio-card min-w-[320px] max-w-[320px] bg-white rounded-2xl overflow-hidden shadow-md hover:shadow-xl hover:-translate-y-2 transition-all duration-300 flex-shrink-0 opacity-0 animate-fadeIn" data-studio-id="${studio.id}">
        <img src="${thumbnail}" alt="${studio.nama_studio}" loading="lazy" class="w-full h-48 object-cover bg-gray-100" onerror="this.src='https://via.placeholder.com/320x192?text=No+Image'">
        <div class="p-5">
          <h3 class="text-xl font-semibold text-[#446178] mb-2 leading-tight">${studio.nama_studio}</h3>
          <p class="text-[#91C4C3] font-medium text-sm mb-1">üìç ${studio.area}, ${studio.kota}</p>
          <p class="text-gray-600 text-sm mb-1 leading-relaxed">üìç ${studio.alamat}</p>
          <p class="text-gray-600 text-sm mb-3 leading-relaxed">üìû ${studio.nomor_telepon}</p>
          <div class="flex gap-2">
            <a href="${gmapsLink}" target="_blank" rel="noopener" 
               class="inline-block mt-2 px-4 py-2 bg-[#FFA04D] text-white rounded-lg text-sm font-medium hover:bg-[#ff8c2e] hover:scale-105 hover:shadow-md transition-all duration-300">
              View on Google Maps ‚Üí
            </a>
            ${deleteButton}
          </div>
        </div>
      </div>
    `;
  }

  // Create empty state HTML
  function createEmptyState(cityName) {
    return `
      <div class="w-full text-center py-16 bg-white rounded-2xl m-4">
        <p class="text-gray-400 text-lg">No studios available in ${cityName} yet.</p>
      </div>
    `;
  }

  // Create city section HTML
  function createCitySection(cityData) {
    const isUserCity = cityData.is_user_city;
    const cityLabel = isUserCity ? 
      `<span class="mr-2">üìç</span>${cityData.name} <span class="ml-2 text-sm font-normal text-[#91C4C3]">(Your City)</span>` :
      cityData.name;
    
    const carouselId = cityData.name.replace(/\s+/g, '-');
    
    let cardsHTML = '';
    if (cityData.studios.length === 0) {
      cardsHTML = createEmptyState(cityData.name);
    } else {
      cardsHTML = cityData.studios.map(studio => createStudioCard(studio)).join('');
    }
    
    return `
      <section class="mb-12 opacity-0 animate-fadeIn">
        <div class="mb-4">
          <h2 class="text-3xl font-semibold text-[#446178] flex items-center">
            ${cityLabel}
          </h2>
        </div>
        
        <div class="carousel-container relative py-4" data-carousel="${carouselId}">
          <button class="hidden absolute top-1/2 left-2 -translate-y-1/2 w-10 h-10 bg-[#FFF7DD]/95 backdrop-blur-md border-2 border-[#446178] text-[#446178] rounded-full flex items-center justify-center cursor-pointer z-10 opacity-70 hover:bg-[#446178] hover:text-[#FFF7DD] hover:opacity-100 hover:scale-110 active:scale-95 transition-all duration-300 shadow-lg" 
                  onclick="scrollCarousel('${carouselId}', -1)" 
                  aria-label="Scroll left">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
            </svg>
          </button>
          
          <div class="cards-wrapper flex gap-6 overflow-x-auto p-4">
            ${cardsHTML}
          </div>
          
          <button class="hidden absolute top-1/2 right-2 -translate-y-1/2 w-10 h-10 bg-[#FFF7DD]/95 backdrop-blur-md border-2 border-[#446178] text-[#446178] rounded-full flex items-center justify-center cursor-pointer z-10 opacity-70 hover:bg-[#446178] hover:text-[#FFF7DD] hover:opacity-100 hover:scale-110 active:scale-95 transition-all duration-300 shadow-lg" 
                  onclick="scrollCarousel('${carouselId}', 1)" 
                  aria-label="Scroll right">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
          </button>
        </div>
      </section>
    `;
  }

  // Load studios via AJAX
  async function loadStudios() {
    const loadingState = document.getElementById('loading-state');
    const errorState = document.getElementById('error-state');
    const contentState = document.getElementById('content-state');
    
    // Show loading state
    loadingState.classList.remove('hidden');
    errorState.classList.add('hidden');
    contentState.classList.add('hidden');
    contentState.innerHTML = '';
    
    try {
      const response = await fetch("{% url 'studio:show_json' %}");
      
      if (!response.ok) {
        throw new Error('Network response was not ok');
      }
      
      const data = await response.json();
      
      // Hide loading, show content
      loadingState.classList.add('hidden');
      contentState.classList.remove('hidden');
      
      // Generate HTML for all cities
      if (data.cities && data.cities.length > 0) {
        const sectionsHTML = data.cities.map(cityData => createCitySection(cityData)).join('');
        contentState.innerHTML = sectionsHTML;
        
        // Trigger animations
        setTimeout(() => {
          const elements = contentState.querySelectorAll('.animate-fadeIn');
          elements.forEach((el, index) => {
            setTimeout(() => {
              el.style.opacity = '1';
            }, index * 50);
          });
        }, 10);
        
        // Initialize carousel controls
        setTimeout(initializeCarousels, 100);
      } else {
        contentState.innerHTML = `
          <div class="bg-white rounded-2xl shadow-lg p-12 text-center">
            <p class="text-gray-400 text-xl">No studios available yet.</p>
          </div>
        `;
      }
      
    } catch (error) {
      console.error('Error loading studios:', error);
      
      // Show error state
      loadingState.classList.add('hidden');
      errorState.classList.remove('hidden');
    }
  }

  // Keyboard navigation (Arrow keys)
  document.addEventListener('keydown', function(e) {
    const focusedCarousel = document.querySelector('.carousel-container:hover');
    if (!focusedCarousel) return;
    
    const carouselId = focusedCarousel.getAttribute('data-carousel');
    
    if (e.key === 'ArrowLeft') {
      scrollCarousel(carouselId, -1);
    } else if (e.key === 'ArrowRight') {
      scrollCarousel(carouselId, 1);
    }
  });

  // Delete studio function
  async function deleteStudio(studioId, studioName) {
    // Confirm deletion
    if (!confirm(`Are you sure you want to delete "${studioName}"?\n\nThis action cannot be undone.`)) {
      return;
    }
    
    try {
      // Get CSRF token
      const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                        document.cookie.split('; ')
                          .find(row => row.startsWith('csrftoken='))
                          ?.split('=')[1];
      
      const response = await fetch(`/studio/delete/${studioId}/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrfToken,
          'Content-Type': 'application/json',
        },
      });
      
      if (!response.ok) {
        throw new Error('Failed to delete studio');
      }
      
      const data = await response.json();
      
      if (data.success) {
        // Remove the card from DOM with animation
        const card = document.querySelector(`[data-studio-id="${studioId}"]`);
        if (card) {
          card.style.opacity = '0';
          card.style.transform = 'scale(0.9)';
          setTimeout(() => {
            card.remove();
            
            // Check if section is now empty
            const section = card.closest('section');
            const cardsWrapper = section?.querySelector('.cards-wrapper');
            if (cardsWrapper && cardsWrapper.children.length === 0) {
              const cityName = section.querySelector('h2').textContent.trim();
              cardsWrapper.innerHTML = createEmptyState(cityName.split('(')[0].trim());
            }
          }, 300);
        }
        
        // Reload page after successful deletion
        alert(data.message);
      }
      
    } catch (error) {
      console.error('Error deleting studio:', error);
      alert('Failed to delete studio. Please try again.');
    }
  }

  // Load studios when page loads
  document.addEventListener('DOMContentLoaded', function() {
    loadStudios();
  });
</script>

<style>
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  .animate-fadeIn {
    animation: fadeIn 0.5s ease-out forwards;
  }
</style>

{% endblock content %}
